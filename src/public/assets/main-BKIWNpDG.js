import{createElementBlock as u,openBlock as g,normalizeClass as x,createElementVNode as i,createTextVNode as a,withDirectives as d,vModelText as p,createCommentVNode as C,Fragment as N,renderList as I,withModifiers as c,toDisplayString as E,withKeys as L,normalizeStyle as A,vShow as f,createApp as M}from"vue";let m=biigle.$require("messages").handleErrorResponse,y=biigle.$require("core.mixins.loader"),R=biigle.$require("uiv.tab"),V=biigle.$require("uiv.tabs"),D=biigle.$require("resource");const h=D("api/v1/tags",{},{delete:{method:"DELETE",url:"api/v1/tags/{id}"},update:{method:"PUT",url:"api/v1/tags/{id}"},getAnnotation:{method:"GET",url:"api/v1/tags/annotation/{id}"},attachTag:{method:"POST",url:"api/v1/tags/annotation/{id}"},detachTag:{method:"DELETE",url:"api/v1/tags/annotation/{id}"},updateTag:{method:"PUT",url:"api/v1/tags/annotation/{id}"},importTags:{method:"POST",url:"api/v1/tags/import"}});let w=[0,.5,.9],q=[360,1,1],U=[0,2,2],_=function(e){let t=e[0]/60,l=Math.floor(t),r=t-l,o=[e[2]*(1-e[1]),e[2]*(1-e[1]*r),e[2]*(1-e[1]*(1-r))],s;switch(l){case 1:s=[o[1],e[2],o[0]];break;case 2:s=[o[0],e[2],o[2]];break;case 3:s=[o[0],o[1],e[2]];break;case 4:s=[o[2],o[0],e[2]];break;case 5:s=[e[2],o[0],o[1]];break;default:s=[e[2],o[2],o[0]]}return s.map(function(n){return Math.round(n*255)})},j=function(e){return e.map(function(t){return t=t.toString(16),t.length===1?"0"+t:t})},b=function(){let e=[0,0,0],t;for(let l=e.length-1;l>=0;l--)t=10*U[l],e[l]=(q[l]-w[l])*Math.random()+w[l],t!==0?e[l]=Math.round(e[l]*t)/t:e[l]=Math.round(e[l]);return"#"+j(_(e)).join("")};const T=(e,t)=>{const l=e.__vccOpts||e;for(const[r,o]of t)l[r]=o;return l},F={name:"TagsMultiSelect",mixins:[y],props:{annotationId:{type:Number,required:!0}},data(){return{isOpen:!1,options:[],selectedOptions:[],search:"",newOption:"",checked:!0}},computed:{filteredOptions(){const e=this.search.toLowerCase();return this.options.filter(l=>l.name.toLowerCase().includes(e)).map(l=>{let r=this.selectedOptions.find(o=>o.id==l.id);return r&&(l.value=r.value),l})}},methods:{toggle(){this.isOpen=!this.isOpen},handleClickOutside(e){this.$el.contains(e.target)||(this.isOpen=!1)},isSelected(e){return this.selectedOptions.some(l=>l.id===e.id)},toggleSelection(e){this.isSelected(e)?(this.selectedOptions=this.selectedOptions.filter(t=>t.id!==e.id),this.detachTag(e)):(this.selectedOptions.push(e),this.attachTag(e))},updateTagValue(e){h.updateTag({id:this.annotationId},{tag_id:e.id,value:e.value}).then(t=>{this.isSelected(e)||this.selectedOptions.push(e)}).catch(function(t){m(t)})},getAnnotationTags(){h.getAnnotation({id:this.annotationId}).then(e=>{for(let t of e.data){const l=this.formatTag(t);this.selectedOptions.push(l)}}).catch(function(e){m(e)})},getAllTags(){h.get().then(e=>{for(let t of e.data)this.options.push(this.formatTag(t))}).catch(function(e){m(e)})},attachTag(e){h.attachTag({id:this.annotationId},{tag_id:e.id}).catch(function(t){m(t)})},detachTag(e){h.detachTag({id:this.annotationId},{tag_id:e.id}).then(t=>{e.value=void 0}).catch(function(t){m(t)})},formatTag(e){return{id:e.id,name:e.name,value:e.pivot}}},mounted(){this.getAllTags(),this.getAnnotationTags(),document.addEventListener("click",this.handleClickOutside)},beforeUnmount(){document.removeEventListener("click",this.handleClickOutside)}},H={class:"dropdown-menu"},P={class:"list-unstyled"},B={class:"checkbox"},K=["title"],z=["checked","onChange"],G=["onUpdate:modelValue","onChange"],J={key:0,class:"text-muted"};function X(e,t,l,r,o,s){return g(),u("span",{class:x(["dropdown",{open:o.isOpen}])},[i("span",{class:"dropdown-toggle",onClick:t[0]||(t[0]=(...n)=>s.toggle&&s.toggle(...n))},[...t[2]||(t[2]=[i("i",{class:"fa fa-tags"},null,-1),a(),i("span",{class:"caret"},null,-1)])]),t[6]||(t[6]=a()),i("div",H,[d(i("input",{"onUpdate:modelValue":t[1]||(t[1]=n=>o.search=n),class:"form-control search",type:"text",placeholder:"Rechercher..."},null,512),[[p,o.search]]),t[5]||(t[5]=a()),i("ul",P,[(g(!0),u(N,null,I(s.filteredOptions,(n,S)=>(g(),u("li",{key:S},[i("div",B,[i("label",{class:"tag",title:n.name},[i("input",{type:"checkbox",checked:s.isSelected(n),onChange:c(v=>s.toggleSelection(n),["prevent"])},null,40,z),a(" "+E(n.name),1)],8,K),t[3]||(t[3]=a()),d(i("input",{class:"form-control tag-value",type:"text","onUpdate:modelValue":v=>n.value=v,onChange:v=>s.updateTagValue(n)},null,40,G),[[p,n.value]])])]))),128)),t[4]||(t[4]=a()),s.filteredOptions.length===0?(g(),u("li",J,"Aucune option")):C("",!0)])])],2)}const Y=T(F,[["render",X],["__scopeId","data-v-36ccc8f8"]]),Q={name:"tag-item",data(){return{hover:!1,editing:!1,oldName:"",oldColor:"",newName:"",newColor:""}},props:{tag:{type:Object,required:!0}},computed:{showColor(){return!0},classObject(){return{"label-tree-label--editing":this.editing}},colorStyle(){return{"background-color":"#"+this.tag.color}},showEditButton(){return this.hover&&!this.editing},editTitle(){return"Edit tag "+this.tag.name},deleteTitle(){return"Remove tag "+this.tag.name}},methods:{editThis(){this.editing=!0,this.oldName=this.tag.name,this.oldColor=this.tag.color,this.newName=this.tag.name,this.newColor="#"+this.tag.color},doHover(){this.hover=!0},dontHover(){this.hover=!1},saveThis(){this.tag.name=this.newName,this.tag.color=this.newColor.substr(1),this.editing=!1,(this.oldName!==this.tag.name||this.oldColor!==this.tag.color)&&this.emitSave(this.tag,()=>this.editing=!0)},revertThis(){this.editing=!1,this.tag.name=this.oldName,this.tag.color=this.oldColor},deleteThis(){this.emitDelete(this.tag)},emitDelete(e){this.$emit("delete",e)},emitSave(e,t){this.$emit("save",e,t)}},created(){console.log(b())}},W={key:0},Z={key:1},$=["textContent"],tt={class:"label-tree-label__buttons"},et=["title"],st=["title"];function nt(e,t,l,r,o,s){return g(),u("li",{class:x(["label-tree-label",s.classObject])},[i("div",{class:"label-tree-label__name",onMouseover:t[8]||(t[8]=(...n)=>s.doHover&&s.doHover(...n)),onMouseleave:t[9]||(t[9]=(...n)=>s.dontHover&&s.dontHover(...n))},[o.editing?(g(),u("span",W,[d(i("input",{type:"color",class:"form-control input-sm label-tree-color-input","onUpdate:modelValue":t[0]||(t[0]=n=>o.newColor=n)},null,512),[[p,o.newColor]]),t[10]||(t[10]=a()),d(i("input",{type:"text","onUpdate:modelValue":t[1]||(t[1]=n=>o.newName=n),onKeydown:t[2]||(t[2]=L((...n)=>s.saveThis&&s.saveThis(...n),["enter"])),class:"form-control input-sm label-tree-label__name-input"},null,544),[[p,o.newName]])])):(g(),u("span",Z,[d(i("span",{class:"label-tree-label__color",style:A(s.colorStyle)},null,4),[[f,s.showColor]]),t[11]||(t[11]=a()),i("span",{textContent:E(l.tag.name),onMouseenter:t[3]||(t[3]=(...n)=>s.dontHover&&s.dontHover(...n))},null,40,$)])),t[19]||(t[19]=a()),i("span",tt,[i("span",null,[d(i("button",{title:s.editTitle,onClick:t[4]||(t[4]=c((...n)=>s.editThis&&s.editThis(...n),["stop"])),class:"btn btn-default btn-xs"},[...t[12]||(t[12]=[i("span",{"aria-hidden":"true",class:"fa fa-pencil-alt"},null,-1)])],8,et),[[f,s.showEditButton]]),t[16]||(t[16]=a()),d(i("button",{title:s.deleteTitle,onClick:t[5]||(t[5]=c((...n)=>s.deleteThis&&s.deleteThis(...n),["stop"])),class:"btn btn-danger btn-sm"},[...t[13]||(t[13]=[i("span",{"aria-hidden":"true",class:"fa fa-trash"},null,-1)])],8,st),[[f,o.editing]]),t[17]||(t[17]=a()),d(i("button",{title:"Save changes",onClick:t[6]||(t[6]=c((...n)=>s.saveThis&&s.saveThis(...n),["stop"])),class:"btn btn-success btn-sm"},[...t[14]||(t[14]=[i("span",{"aria-hidden":"true",class:"fa fa-check"},null,-1)])],512),[[f,o.editing]]),t[18]||(t[18]=a()),d(i("button",{title:"Revert changes",onClick:t[7]||(t[7]=c((...n)=>s.revertThis&&s.revertThis(...n),["stop"])),class:"btn btn-default btn-sm"},[...t[15]||(t[15]=[i("span",{"aria-hidden":"true",class:"fa fa-times"},null,-1)])],512),[[f,o.editing]])])])],32)],2)}const it=T(Q,[["render",nt]]),lt={data(){return{name:"",color:b()}},computed:{hasNoName(){return!this.name}},methods:{refreshColor(){this.color=b()},submit(){let e={name:this.name,color:this.color.substr(1)};this.name="",this.color=b(),this.$emit("submit",e)}}},ot={class:"row"},at={class:"col-xs-4 form-group"},rt={class:"input-group"},dt={class:"input-group-btn"},ut={class:"col-xs-4 form-group"},gt={class:"input-group"},ht={class:"input-group-btn"},mt=["disabled"];function ct(e,t,l,r,o,s){return g(),u("form",{onSubmit:t[3]||(t[3]=c((...n)=>s.submit&&s.submit(...n),["prevent"]))},[i("div",ot,[t[8]||(t[8]=i("div",{class:"col-xs-12 help-block"},`
                To add a new tag, choose a color and a name.
            `,-1)),t[9]||(t[9]=a()),i("div",at,[i("div",rt,[d(i("input",{type:"color",class:"form-control",title:"Label color","onUpdate:modelValue":t[0]||(t[0]=n=>o.color=n)},null,512),[[p,o.color]]),t[5]||(t[5]=a()),i("span",dt,[i("button",{class:"btn btn-default",type:"button",title:"Get a random color",onClick:t[1]||(t[1]=(...n)=>s.refreshColor&&s.refreshColor(...n))},[...t[4]||(t[4]=[i("span",{class:"fa fa-sync-alt","aria-hidden":"true"},null,-1)])])])])]),t[10]||(t[10]=a()),i("div",ut,[i("div",gt,[d(i("input",{type:"text",class:"form-control",placeholder:"Tag name",title:"New tag name","onUpdate:modelValue":t[2]||(t[2]=n=>o.name=n)},null,512),[[p,o.name]]),t[7]||(t[7]=a()),i("span",ht,[i("button",{class:"btn btn-success",type:"submit",title:"Add the new tag",disabled:s.hasNoName},[...t[6]||(t[6]=[i("span",{class:"fa fa-plus","aria-hidden":"true"},null,-1)])],8,mt)])])])])],32)}const pt=T(lt,[["render",ct]]),ft={mixins:[y],data(){return{error:!1,success:!1,data:null}},methods:{handleSuccess(){this.error=!1,this.success=!0,this.$emit("refresh")},handleError(e){this.success=!1;let t=e.body.errors&&e.body.errors.file;t?Array.isArray(t)?this.error=t[0]:this.error=t:this.handleErrorResponse(e)},handleFile(e){this.startLoading(),this.data=e.target.files[0],console.log(this.data)},handleFinally(){this.data=null,this.finishLoading()},importTags(){let e=new FormData;e.append("file",this.data),h.importTags(e).then(this.handleSuccess).catch(this.handleError).finally(this.handleFinally)}}},bt={class:"form-group"},Tt=["disabled"],vt={key:0,class:"info bg-success text-success"},Ct={key:1,class:"info bg-danger text-danger"};function yt(e,t,l,r,o,s){return g(),u("div",bt,[t[2]||(t[2]=i("label",null,"Select a file",-1)),t[3]||(t[3]=a()),i("input",{type:"file",name:"import",onChange:t[0]||(t[0]=(...n)=>s.handleFile&&s.handleFile(...n))},null,32),t[4]||(t[4]=a()),t[5]||(t[5]=i("span",{class:"help-block"},`
            The file must be a textfile with tags separated by newline
        `,-1)),t[6]||(t[6]=a()),i("button",{class:"btn btn-success",onClick:t[1]||(t[1]=(...n)=>s.importTags&&s.importTags(...n)),disabled:!o.data},"Import",8,Tt),t[7]||(t[7]=a()),o.success?(g(),u("p",vt,`
            Tags successfully imported. Refresh the page.
        `)):C("",!0),t[8]||(t[8]=a()),o.error?(g(),u("p",Ct,`
            There was an error importing the file.
        `)):C("",!0)])}const wt=T(ft,[["render",yt],["__scopeId","data-v-7e42cad3"]]),kt={mixins:[y],data(){return{tags:[]}},components:{tagItem:it,tagForm:pt,tagImport:wt,tabs:V,tab:R},methods:{saveTag(e,t){h.update({id:e.id},{name:e.name,color:e.color}).catch(function(l){t(),m(l)}).finally(this.finishLoading)},deleteTag(e){this.startLoading(),h.delete({id:e.id}).then(()=>{this.tagDeleted(e)},m)},tagDeleted(e){for(let t=this.tags.length-1;t>=0;t--)if(this.tags[t].id===e.id){this.tags.splice(t,1);break}},createTag(e){this.loading||(console.log(e),this.startLoading(),h.save({},e).then(this.tagCreated,m).finally(this.finishLoading))},tagCreated(e){this.insertTag(e.data)},insertTag(e){let t=e.name.toLowerCase();for(let l=0,r=this.tags.length;l<r;l++)if(this.tags[l].name.toLowerCase()>=t){this.tags.splice(l,0,e);return}this.tags.push(e)},refresh(){console.log("refresh tags")}},created(){this.tags=biigle.$require("tagsDisplay.tags")}},Ot=".annotations-tab-item__sub-item",k="__child_injected__";function xt(){O(),new MutationObserver(()=>{O()}).observe(document.body,{childList:!0,subtree:!0})}function Et(e){if(e[k])return;const t=document.createElement("i");t.style="float: right;",e.appendChild(t);const l={annotationId:Number(e.dataset.annotationId)};M(Y,l).mount(t),e[k]=!0}function O(){const e=document.querySelectorAll(Ot);for(const t of e)Et(t)}window.startInjectionObserver=xt;biigle.$mount("tags-container",kt);
