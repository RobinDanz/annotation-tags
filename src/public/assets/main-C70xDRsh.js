import S,{createElementBlock as g,openBlock as m,normalizeClass as O,createElementVNode as l,createTextVNode as a,withDirectives as d,vModelText as f,createCommentVNode as N,Fragment as L,renderList as M,withModifiers as c,toDisplayString as x,withKeys as A,normalizeStyle as V,vShow as p}from"vue";let h=biigle.$require("messages").handleErrorResponse,C=biigle.$require("core.mixins.loader"),D=biigle.$require("uiv.tab"),I=biigle.$require("uiv.tabs"),_=biigle.$require("resource");const u=_("api/v1/tags",{},{delete:{method:"DELETE",url:"api/v1/tags/{id}"},update:{method:"PUT",url:"api/v1/tags/{id}"},getAnnotation:{method:"GET",url:"api/v1/tags/annotation/{id}"},attachTag:{method:"POST",url:"api/v1/tags/annotation/{id}"},detachTag:{method:"DELETE",url:"api/v1/tags/annotation/{id}"},updateTag:{method:"PUT",url:"api/v1/tags/annotation/{id}"},importTags:{method:"POST",url:"api/v1/tags/import"}});let w=[0,.5,.9],R=[360,1,1],U=[0,2,2],q=function(e){let t=e[0]/60,n=Math.floor(t),r=t-n,o=[e[2]*(1-e[1]),e[2]*(1-e[1]*r),e[2]*(1-e[1]*(1-r))],s;switch(n){case 1:s=[o[1],e[2],o[0]];break;case 2:s=[o[0],e[2],o[2]];break;case 3:s=[o[0],o[1],e[2]];break;case 4:s=[o[2],o[0],e[2]];break;case 5:s=[e[2],o[0],o[1]];break;default:s=[e[2],o[2],o[0]]}return s.map(function(i){return Math.round(i*255)})},F=function(e){return e.map(function(t){return t=t.toString(16),t.length===1?"0"+t:t})},b=function(){let e=[0,0,0],t;for(let n=e.length-1;n>=0;n--)t=10*U[n],e[n]=(R[n]-w[n])*Math.random()+w[n],t!==0?e[n]=Math.round(e[n]*t)/t:e[n]=Math.round(e[n]);return"#"+F(q(e)).join("")};const T=(e,t)=>{const n=e.__vccOpts||e;for(const[r,o]of t)n[r]=o;return n},H={name:"TagsMultiSelect",mixins:[C],data(){return{isOpen:!1,options:[],selectedOptions:[],search:"",newOption:"",checked:!0}},computed:{filteredOptions(){const e=this.search.toLowerCase();return this.options.filter(n=>n.name.toLowerCase().includes(e)).map(n=>{let r=this.selectedOptions.find(o=>o.id==n.id);return r&&(n.value=r.value),n})}},methods:{toggle(){this.isOpen=!this.isOpen},handleClickOutside(e){this.$el.contains(e.target)||(this.isOpen=!1)},isSelected(e){return this.selectedOptions.some(n=>n.id===e.id)},toggleSelection(e){this.isSelected(e)?(this.selectedOptions=this.selectedOptions.filter(t=>t.id!==e.id),this.detachTag(e)):(this.selectedOptions.push(e),this.attachTag(e))},updateTagValue(e){u.updateTag({id:this.$parent.annotation.id},{tag_id:e.id,value:e.value}).then(t=>{this.selectedOptions.push(e)}).catch(function(t){h(t)})},getAnnotationTags(){u.getAnnotation({id:this.$parent.annotation.id}).then(e=>{for(let t of e.data){const n=this.formatTag(t);this.selectedOptions.push(n)}}).catch(function(e){h(e)})},getAllTags(){u.get().then(e=>{for(let t of e.data)this.options.push(this.formatTag(t))}).catch(function(e){h(e)})},attachTag(e){u.attachTag({id:this.$parent.annotation.id},{tag_id:e.id}).catch(function(t){h(t)})},detachTag(e){u.detachTag({id:this.$parent.annotation.id},{tag_id:e.id}).then(t=>{e.value=void 0}).catch(function(t){h(t)})},deleteTag(e){this.options=this.options.filter(t=>t.id!==e.id),this.selectedOptions=this.selectedOptions.filter(t=>t.id!==e.id),u.delete({id:e.id}).catch(function(t){h(t)})},formatTag(e){return{id:e.id,name:e.name,value:e.pivot}}},mounted(){this.getAllTags(),this.getAnnotationTags(),document.addEventListener("click",this.handleClickOutside)},beforeUnmount(){document.removeEventListener("click",this.handleClickOutside)}},j={class:"dropdown-menu"},P={class:"list-unstyled"},B={class:"checkbox"},$={class:"tag-selected"},K=["checked","onChange"],z=["onUpdate:modelValue","onChange"],G={key:0,class:"text-muted"};function J(e,t,n,r,o,s){return m(),g("span",{class:O(["dropdown",{open:o.isOpen}])},[l("span",{class:"dropdown-toggle",onClick:t[0]||(t[0]=(...i)=>s.toggle&&s.toggle(...i))},[...t[2]||(t[2]=[l("i",{class:"fa fa-tags"},null,-1),a(),l("span",{class:"caret"},null,-1)])]),t[6]||(t[6]=a()),l("div",j,[d(l("input",{"onUpdate:modelValue":t[1]||(t[1]=i=>o.search=i),class:"form-control",type:"text",placeholder:"Rechercher..."},null,512),[[f,o.search]]),t[5]||(t[5]=a()),l("ul",P,[(m(!0),g(L,null,M(s.filteredOptions,(i,E)=>(m(),g("li",{key:E},[l("div",B,[l("label",$,[l("input",{type:"checkbox",checked:s.isSelected(i),onChange:c(v=>s.toggleSelection(i),["prevent"])},null,40,K),a(" "+x(i.name),1)]),t[3]||(t[3]=a()),d(l("input",{class:"form-control tag-value",type:"text","onUpdate:modelValue":v=>i.value=v,onChange:v=>s.updateTagValue(i)},null,40,z),[[f,i.value]])])]))),128)),t[4]||(t[4]=a()),s.filteredOptions.length===0?(m(),g("li",G,"Aucune option")):N("",!0)])])],2)}const X=T(H,[["render",J],["__scopeId","data-v-03d8435b"]]),Y={name:"tag-item",data(){return{hover:!1,editing:!1,oldName:"",oldColor:"",newName:"",newColor:""}},props:{tag:{type:Object,required:!0}},computed:{showColor(){return!0},classObject(){return{"label-tree-label--editing":this.editing}},colorStyle(){return{"background-color":"#"+this.tag.color}},showEditButton(){return this.hover&&!this.editing},editTitle(){return"Edit tag "+this.tag.name},deleteTitle(){return"Remove tag "+this.tag.name}},methods:{editThis(){this.editing=!0,this.oldName=this.tag.name,this.oldColor=this.tag.color,this.newName=this.tag.name,this.newColor="#"+this.tag.color},doHover(){this.hover=!0},dontHover(){this.hover=!1},saveThis(){this.tag.name=this.newName,this.tag.color=this.newColor.substr(1),this.editing=!1,(this.oldName!==this.tag.name||this.oldColor!==this.tag.color)&&this.emitSave(this.tag,()=>this.editing=!0)},revertThis(){this.editing=!1,this.tag.name=this.oldName,this.tag.color=this.oldColor},deleteThis(){this.emitDelete(this.tag)},emitDelete(e){this.$emit("delete",e)},emitSave(e,t){this.$emit("save",e,t)}},created(){console.log(b())}},Q={key:0},W={key:1},Z=["textContent"],tt={class:"label-tree-label__buttons"},et=["title"],st=["title"];function nt(e,t,n,r,o,s){return m(),g("li",{class:O(["label-tree-label",s.classObject])},[l("div",{class:"label-tree-label__name",onMouseover:t[8]||(t[8]=(...i)=>s.doHover&&s.doHover(...i)),onMouseleave:t[9]||(t[9]=(...i)=>s.dontHover&&s.dontHover(...i))},[o.editing?(m(),g("span",Q,[d(l("input",{type:"color",class:"form-control input-sm label-tree-color-input","onUpdate:modelValue":t[0]||(t[0]=i=>o.newColor=i)},null,512),[[f,o.newColor]]),t[10]||(t[10]=a()),d(l("input",{type:"text","onUpdate:modelValue":t[1]||(t[1]=i=>o.newName=i),onKeydown:t[2]||(t[2]=A((...i)=>s.saveThis&&s.saveThis(...i),["enter"])),class:"form-control input-sm label-tree-label__name-input"},null,544),[[f,o.newName]])])):(m(),g("span",W,[d(l("span",{class:"label-tree-label__color",style:V(s.colorStyle)},null,4),[[p,s.showColor]]),t[11]||(t[11]=a()),l("span",{textContent:x(n.tag.name),onMouseenter:t[3]||(t[3]=(...i)=>s.dontHover&&s.dontHover(...i))},null,40,Z)])),t[19]||(t[19]=a()),l("span",tt,[l("span",null,[d(l("button",{title:s.editTitle,onClick:t[4]||(t[4]=c((...i)=>s.editThis&&s.editThis(...i),["stop"])),class:"btn btn-default btn-xs"},[...t[12]||(t[12]=[l("span",{"aria-hidden":"true",class:"fa fa-pencil-alt"},null,-1)])],8,et),[[p,s.showEditButton]]),t[16]||(t[16]=a()),d(l("button",{title:s.deleteTitle,onClick:t[5]||(t[5]=c((...i)=>s.deleteThis&&s.deleteThis(...i),["stop"])),class:"btn btn-danger btn-sm"},[...t[13]||(t[13]=[l("span",{"aria-hidden":"true",class:"fa fa-trash"},null,-1)])],8,st),[[p,o.editing]]),t[17]||(t[17]=a()),d(l("button",{title:"Save changes",onClick:t[6]||(t[6]=c((...i)=>s.saveThis&&s.saveThis(...i),["stop"])),class:"btn btn-success btn-sm"},[...t[14]||(t[14]=[l("span",{"aria-hidden":"true",class:"fa fa-check"},null,-1)])],512),[[p,o.editing]]),t[18]||(t[18]=a()),d(l("button",{title:"Revert changes",onClick:t[7]||(t[7]=c((...i)=>s.revertThis&&s.revertThis(...i),["stop"])),class:"btn btn-default btn-sm"},[...t[15]||(t[15]=[l("span",{"aria-hidden":"true",class:"fa fa-times"},null,-1)])],512),[[p,o.editing]])])])],32)],2)}const it=T(Y,[["render",nt]]),lt={data(){return{name:"",color:b()}},computed:{hasNoName(){return!this.name}},methods:{refreshColor(){this.color=b()},submit(){let e={name:this.name,color:this.color.substr(1)};this.name="",this.color=b(),this.$emit("submit",e)}}},ot={class:"row"},at={class:"col-xs-4 form-group"},rt={class:"input-group"},dt={class:"input-group-btn"},ut={class:"col-xs-4 form-group"},ht={class:"input-group"},gt={class:"input-group-btn"},mt=["disabled"];function ct(e,t,n,r,o,s){return m(),g("form",{onSubmit:t[3]||(t[3]=c((...i)=>s.submit&&s.submit(...i),["prevent"]))},[l("div",ot,[t[8]||(t[8]=l("div",{class:"col-xs-12 help-block"},`
                To add a new tag, choose a color and a name.
            `,-1)),t[9]||(t[9]=a()),l("div",at,[l("div",rt,[d(l("input",{type:"color",class:"form-control",title:"Label color","onUpdate:modelValue":t[0]||(t[0]=i=>o.color=i)},null,512),[[f,o.color]]),t[5]||(t[5]=a()),l("span",dt,[l("button",{class:"btn btn-default",type:"button",title:"Get a random color",onClick:t[1]||(t[1]=(...i)=>s.refreshColor&&s.refreshColor(...i))},[...t[4]||(t[4]=[l("span",{class:"fa fa-sync-alt","aria-hidden":"true"},null,-1)])])])])]),t[10]||(t[10]=a()),l("div",ut,[l("div",ht,[d(l("input",{type:"text",class:"form-control",placeholder:"Tag name",title:"New tag name","onUpdate:modelValue":t[2]||(t[2]=i=>o.name=i)},null,512),[[f,o.name]]),t[7]||(t[7]=a()),l("span",gt,[l("button",{class:"btn btn-success",type:"submit",title:"Add the new tag",disabled:s.hasNoName},[...t[6]||(t[6]=[l("span",{class:"fa fa-plus","aria-hidden":"true"},null,-1)])],8,mt)])])])])],32)}const ft=T(lt,[["render",ct]]),pt={mixins:[C],data(){return{error:!1,success:!1,data:null}},methods:{handleSuccess(){this.error=!1,this.success=!0,this.$emit("refresh")},handleError(e){this.success=!1;let t=e.body.errors&&e.body.errors.file;t?Array.isArray(t)?this.error=t[0]:this.error=t:this.handleErrorResponse(e)},handleFile(e){this.startLoading(),this.data=e.target.files[0],console.log(this.data)},handleFinally(){this.data=null,this.finishLoading()},importTags(){let e=new FormData;e.append("file",this.data),u.importTags(e).then(this.handleSuccess).catch(this.handleError).finally(this.handleFinally)}}},bt={class:"form-group"},Tt=["disabled"];function vt(e,t,n,r,o,s){return m(),g("div",bt,[t[2]||(t[2]=l("label",null,"Select a file",-1)),t[3]||(t[3]=a()),l("input",{type:"file",name:"import",onChange:t[0]||(t[0]=(...i)=>s.handleFile&&s.handleFile(...i))},null,32),t[4]||(t[4]=a()),t[5]||(t[5]=l("span",{class:"help-block"},`
            The file must be a textfile with a tags separated by newline
        `,-1)),t[6]||(t[6]=a()),l("button",{class:"btn btn-success",onClick:t[1]||(t[1]=(...i)=>s.importTags&&s.importTags(...i)),disabled:!o.data},"Click !",8,Tt)])}const Ct=T(pt,[["render",vt]]),wt={mixins:[C],data(){return{tags:[]}},components:{tagItem:it,tagForm:ft,tagImport:Ct,tabs:I,tab:D},methods:{saveTag(e,t){u.update({id:e.id},{name:e.name,color:e.color}).catch(function(n){t(),h(n)}).finally(this.finishLoading)},deleteTag(e){this.startLoading(),u.delete({id:e.id}).then(()=>{this.tagDeleted(e)},h)},tagDeleted(e){for(let t=this.tags.length-1;t>=0;t--)if(this.tags[t].id===e.id){this.tags.splice(t,1);break}},createTag(e){this.loading||(console.log(e),this.startLoading(),u.save({},e).then(this.tagCreated,h).finally(this.finishLoading))},tagCreated(e){this.insertTag(e.data)},insertTag(e){let t=e.name.toLowerCase();for(let n=0,r=this.tags.length;n<r;n++)if(this.tags[n].name.toLowerCase()>=t){this.tags.splice(n,0,e);return}this.tags.push(e)},refresh(){console.log("refresh tags")}},created(){this.tags=biigle.$require("tagsDisplay.tags")}},yt=".annotations-tab-item__sub-item",y="__child_injected__";function kt(e){if(e[y])return;const t=S.extend(X),n=new t({parent:e,propsData:{}});n.$mount(),e.$el.appendChild(n.$el),e[y]=n}function k(){const e=document.querySelectorAll(yt);for(const t of e){const n=t.__vue__;n&&kt(n)}}function Ot(){k(),new MutationObserver(()=>{k()}).observe(document.body,{childList:!0,subtree:!0})}Ot();biigle.$mount("tags-container",wt);
